@{
    ViewData["Title"] = "Buscador";
}

<style>
#chartTitle {
    text-align: center;
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 10px;
    opacity: 0;
    transform: translateY(-10px);
    transition: opacity 0.4s, transform 0.4s;
}

#chartContainer.animate #chartTitle {
    opacity: 1;
    transform: translateY(0);
}
    body {
        transition: background 0.3s, color 0.3s;
    }

    .top-buttons {
        display: flex;
        justify-content: space-between;

        margin-bottom: 25px;
    }

    #searchWordsBtn {
        padding: 14px 26px;
        border: none;
        cursor: pointer;
        border-radius: 12px;
        background: linear-gradient(135deg, #5b6dff, #7b5bff);
        color: white;
        font-size: 20px;
        font-weight: 600;
        transition: transform 0.18s;
    }

    #processBtn {
        padding: 14px 26px;
        border: none;
        cursor: pointer;
        border-radius: 12px;
        background: linear-gradient(135deg, #00c9a7, #00e8b5);
        color: white;
        font-size: 20px;
        font-weight: 600;
        transition: transform 0.18s;
    }

    #searchHtmlBtn {
        padding: 14px 26px;
        border: none;
        cursor: pointer;
        border-radius: 12px;
        background: linear-gradient(135deg, #ff6b8a, #ff8e4d);
        color: white;
        font-size: 20px;
        font-weight: 600;
        transition: transform 0.18s;
    }

    button:hover { transform: scale(1.06); }

    #searchInput {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 18px;
        margin-bottom: 15px;
    }

    #resultBox {
        margin-top: 20px;
        padding: 15px;
        background: white;
        border-radius: 10px;
        max-height: 350px;
        overflow-y: auto;
        display: none;
        white-space: pre-wrap;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    #chartContainer {
        margin-top: 25px;
        display: none;
        padding: 10px;
    }

    body.dark {
        background: #121212;
        color: #eaeaea;
    }

    body.dark #resultBox {
        background: #1e1e1e;
        color: white;
    }

    body.dark #searchInput {
        background: #1e1e1e;
        border: 1px solid #555;
        color: white;
    }

</style>

<style>

@@keyframes slideInLeft {
    0% {
        opacity: 0;
        transform: translateX(-40px);
    }
    100% {
        opacity: 1;
        transform: translateX(0);
    }
}

#chartContainer.animate {
    animation: slideInLeft 0.6s ease-out;
}

#contentWrapper {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

#chartContainer {
    width: 45%;
    min-width: 300px;
    display: none;
}

#resultBox {
    width: 55%;
}

@@media (max-width: 900px) {
    #contentWrapper {
        flex-direction: column;
    }
    
    #chartContainer, #resultBox {
        width: 100%;
    }
}

    #darkModeBtn {
        padding: 8px 16px;
        font-size: 15px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: 0.2s;
    }

    #darkModeBtn:hover {
        transform: scale(1.06);
    }
</style>

<div class="top-buttons">
    <button id="searchWordsBtn">Palabras</button>
    <button id="processBtn">Procesar</button>
    <button id="searchHtmlBtn">HTML</button>
</div>

<input id="searchInput" type="text" placeholder="Escribe aquí...">

<div id="contentWrapper">

<div id="chartContainer">
    <h2 id="chartTitle">Top 5 Resultados</h2>
    <canvas id="myChart"></canvas>
</div>

    <div id="resultBox"></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>

function openHtmlFile(fileName) {
    // Eliminar la extensión si ya está presente
    const cleanName = fileName.replace(/\.html$/i, '');
    // Redirigir a la acción AbrirArchivo en el controlador
    window.location.href = `/Home/AbrirArchivo?nombre=${encodeURIComponent(cleanName)}`;
}

document.addEventListener("DOMContentLoaded", () => {

    const searchWordsBtn = document.getElementById("searchWordsBtn");
    const searchHtmlBtn = document.getElementById("searchHtmlBtn");
    const processBtn = document.getElementById("processBtn");
    const searchInput = document.getElementById("searchInput");
    const resultBox = document.getElementById("resultBox");
    const chartContainer = document.getElementById("chartContainer");
    const darkModeBtn = document.getElementById("darkModeBtn");


    function getTop5(texto) {
        const regex = /([\w\-]+)\s*\(?(\d+(?:\.\d+)?)%\)?/g;
        const resultados = [];
        let m;

        while ((m = regex.exec(texto)) !== null) {
            resultados.push({
                nombre: m[1].replace(".html",""),
                porcentaje: parseFloat(m[2])
            });
        }

        resultados.sort((a,b) => b.porcentaje - a.porcentaje);
        return resultados.slice(0, 5);
    }

    let chartInstance = null;

    function renderChart(top5) {
        if (!top5 || top5.length === 0) {
            chartContainer.style.display = "none";
            return;
        }
        chartContainer.style.display = "block";
        
        chartContainer.classList.remove("animate");
        void chartContainer.offsetWidth;
        chartContainer.classList.add("animate");
        
        const ctx = document.getElementById("myChart");
        
        if (chartInstance) chartInstance.destroy();
        
        chartInstance = new Chart(ctx, {
            
            type: "bar",
            data: {
                labels: top5.map(x => x.nombre),
                datasets: [{
                    label: "Porcentaje",
                    data: top5.map(x => x.porcentaje),
                    backgroundColor: [
                        "#6c63ff", "#ff6584", "#3ecf8e", "#ffce59", "#4bc0c0"
                    ]
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        if (document.body.classList.contains("dark")) {
            chartInstance.options.scales.x.ticks.color = "white";
            chartInstance.options.scales.y.ticks.color = "white";
            chartInstance.update();
        }
    }


    processBtn.addEventListener("click", () => {

        fetch("/Home/ProcesarArchivos", { method: "POST" })
            .then(res => res.text())
            .then(data => {
                resultBox.style.display = "block";
                resultBox.innerText = data;
                chartContainer.style.display = "none";
            });
    });


    searchWordsBtn.addEventListener("click", () => {

        const q = searchInput.value.trim();
        if (!q) return;

        fetch(`/Home/BuscarTokenAjax?token=${encodeURIComponent(q)}`)
            .then(r => r.text())
            .then(text => {

                resultBox.style.display = "block";
                resultBox.innerHTML = text.replace(/\n/g, "<br>");

                const top5 = getTop5(text);
                renderChart(top5);
            });
    });


    searchHtmlBtn.addEventListener("click", () => {

        const q = searchInput.value.trim();
        if (!q) return;

        fetch(`/Home/BuscarArchivoAjax?archivo=${encodeURIComponent(q)}`)
            .then(r => r.text())
            .then(text => {

                resultBox.style.display = "block";
                resultBox.innerHTML = text.replace(/\n/g, "<br>");

                const top5 = getTop5(text);
                renderChart(top5);
            });
    });


    let dark = localStorage.getItem("darkMode") === "true";

    function applyDark() {
        if (dark) {
            document.body.classList.add("dark");
            darkModeBtn.innerText = "☀️ Modo Claro";
        } else {
            document.body.classList.remove("dark");
            darkModeBtn.innerText = "🌙 Modo Oscuro";
        }

        if (chartInstance) {
            const color = dark ? "white" : "black";
            chartInstance.options.scales.x.ticks.color = color;
            chartInstance.options.scales.y.ticks.color = color;
            chartInstance.update();
        }
    }

    applyDark();

    darkModeBtn.addEventListener("click", () => {
        dark = !dark;
        localStorage.setItem("darkMode", dark);
        applyDark();
    });

});
</script>
